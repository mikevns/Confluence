define("confluence/manage-watchers",["document","ajs","confluence/legacy","confluence/templates","confluence/api/constants"],function(j,c,q,m,n){return function(g){g(j).on("click","#manage-watchers-menu-item, .cw-manage-watchers",function(j){function o(h,b){var a=h.find("#add-"+b+"-watcher-user"),e=h.find("#add-"+b+"-watcher-username"),f,k=h.find("> .status");f={clear:function(){k.addClass("hidden").removeClass("loading error").text("")},loading:function(a){k.addClass("loading").removeClass("hidden error").html(a)},
error:function(a){k.addClass("error").removeClass("hidden loading").html(a)}};h.ajaxForm({beforeSerialize:function(){""==e.val()&&e.val(a.val())},beforeSubmit:function(){a.blur().prop("disabled",!0);l.addClass("updating");f.loading(c.I18n.getText("manage.watchers.status.adding.watcher"))},dataType:"json",error:function(a,d){console.error("Failed to add watcher: "+d)},success:function(b){e.val("");a.prop("disabled",!1).val("").focus();l.removeClass("updating");b.actionErrors&&b.actionErrors.length?
f.error(b.actionErrors[0]):(d.trigger("list-data-retrieved.manage-watchers",{list:l,watchers:b.pageWatchers,type:"page"}),d.trigger("list-data-retrieved.manage-watchers",{list:p,watchers:b.spaceWatchers,type:"space"}),f.clear())}});a.bind("selected.autocomplete-user-or-group",function(){h.submit()})}j.preventDefault();var i=new c.ConfluenceDialog({width:865,height:530,id:"manage-watchers-dialog",onCancel:function(){i.hide().remove()}});i.addHeader(c.I18n.getText("manage.watchers.dialog.title"));i.addPanel("default",
m.ManageWatchers.dialogContent({pageId:c.Meta.get("page-id"),xsrfToken:c.Meta.get("atl-token")}));i.addCancel(c.I18n.getText("close.name"),function(){i.hide().remove();return!1});i.show();var d=g("#manage-watchers-dialog");d.find(".dialog-title").prepend(m.ManageWatchers.helpLink());c.Confluence.Binder.placeholder();d.bind("remove-list-item.manage-watchers",function(h,b){var a=b.item,e=b.list,f=b.username,k=b.type;a.addClass("removing");c.safe.ajax({dataType:"json",type:"POST",url:n.CONTEXT_PATH+
"/json/removewatch.action",data:{pageId:c.params.pageId,username:f,type:k},error:function(){console.error(c.I18n.getText("manage.watchers.unable.to.remove.error"));a.removeClass("removing")},success:function(){a.slideUp().remove();d.trigger("list-updated.manage-watchers",{list:e})}})});d.bind("list-updated.manage-watchers",function(d,b){var a=b.list;0<g("li.watch-user",a).length?(a.find(".no-users").addClass("hidden"),q.Binder.userHover(),a.find(".confluence-userlink").each(function(){g(this).click(function(a){a.preventDefault()})})):
a.find(".no-users").removeClass("hidden")});d.bind("list-data-retrieved.manage-watchers",function(c,b){var a=b.list,e=b.watchers,f=b.type;a.find(".watch-user").remove();e&&e.length&&g.each(e,function(){var b=this.name,c=g(m.ManageWatchers.userItem({username:b,fullName:this.fullName,url:n.CONTEXT_PATH+"/display/~"+this.name,iconUrl:this.avatarUrl}));a.append(c);c.find(".remove-watch").click(function(){d.trigger("remove-list-item.manage-watchers",{username:b,item:c,list:a,type:f})})});a.find(".loading").hide();
d.trigger("list-updated.manage-watchers",{list:a})});var l=d.find(".page-watchers .user-list"),p=d.find(".space-watchers .user-list");c.safe.ajax({url:n.CONTEXT_PATH+"/json/listwatchers.action",dataType:"json",data:{pageId:c.params.pageId},error:function(){console.error("Failed to retrieve watchers.")},success:function(c){d.trigger("list-data-retrieved.manage-watchers",{list:l,watchers:c.pageWatchers,type:"page"});d.trigger("list-data-retrieved.manage-watchers",{list:p,watchers:c.spaceWatchers,type:"space"})}});
o(d.find("#manage-page-watchers-form"),"page");o(d.find("#manage-space-watchers-form"),"space")})}});require("confluence/module-exporter").safeRequire("confluence/manage-watchers",function(j){require("ajs").toInit(j)});