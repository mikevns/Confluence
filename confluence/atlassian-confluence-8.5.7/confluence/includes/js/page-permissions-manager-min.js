define("confluence/page-permissions-manager","ajs confluence/meta confluence/api/event confluence/legacy confluence/aui-overrides confluence/form-state-control".split(" "),function(a,k,w,n,x,f){return function(c){function q(i){var b=d.makePermissionMap(false),b=[].concat(b.group.view).concat(b.user.view).concat(b.group.edit).concat(b.user.edit),o=c("#page-inherited-permissions-table-desc:visible");a.trigger("edit-page-restrictions-updated",{hasExplicitRestrictions:b.length>0,hasInheritedRestrictions:o.length>
0,restrictionsHash:i})}function r(){g.validator.resetValidationErrors();d.clearHighlight();c(".button-spinner").spinStop();e.hide();window.scrollTo(h.bookmark.scrollX,h.bookmark.scrollY)}function y(){g.validator.resetValidationErrors();var i=c(".permissions-update-button");f.disableElement(i);c(".button-spinner").spin();var b=h.makePermissionStrings();b.pageId=a.params.pageId;b.contentId=k.get("content-id");c("#waitImage").show();a.safe.ajax({url:p+"/pages/setcontentpermissions.action",data:b,dataType:"json",
success:function(a){c("#waitImage").hide();if(a.errorMessage){g.validator.showErrorMessage(a.errorMessage);c(".button-spinner").spinStop();f.enableElement(i)}else{m()?q(a.restrictionsHash):w.trigger("system-content-metadata.toggled-restrictions",{hasExplicitRestrictions:a.hasPermissions,hasInheritedRestrictions:a.hasPermissions});f.enableElement(i);r()}},error:function(){g.validator.showErrorMessage(a.I18n.getText("page.restrictions.loading.error"));c(".button-spinner").spinStop();f.enableElement(i)}})}
function s(){r();m()&&d.restoreBackup();return false}function t(i){h.bookmark={scrollX:document.documentElement.scrollLeft,scrollY:document.documentElement.scrollTop};f.disableElement(c(".permissions-update-button"));c(".button-panel-cancel-link").text(a.I18n.getText("close.name"));g.setVisible(i.userCanEditRestrictions);x.setVisible(".permissions-update-button",i.userCanEditRestrictions);e.show()}function u(a,b){var e=b&&c("#newSpaceKey").val()||k.get("space-key"),g=b&&c("#parentPageString").val()||
"",e={contentId:k.get("content-id"),parentPageId:k.get("parent-page-id"),parentPageTitle:g,spaceKey:e},g=p+"/pages/getcontentpermissions.action";c("#waitImage").show();c.getJSON(g,e,function(b){c("#waitImage").hide();if(b.error)d.showErrorMessage(b.error);else{var e=k.get("content-id");d.allowEditing(b.userCanEditRestrictions);d.resetInherited();d.resetDirect();if(b){for(var g=0,h=b.permissions.length;g<h;g++){var l=b.permissions[g],o=l[0].toLowerCase(),j=l[2],j=l[1]==v?b.users[j]:b.groups[j],f=l[3],
l=l[4],z=+f&&f!=e,j={owningId:f,entity:j.entity,report:j.report};j[o]=true;j.owningTitle=l;j.inherited=z;d.addRow(j,o)}b.permissions.length>0&&n.Binder.userHover();d.saveBackup();d.refresh()}}a(b);!b.error&&m()&&q(b.restrictionsHash)})}function A(){f.enableElement(c(".permissions-update-button"));c(".button-panel-cancel-link").text(a.I18n.getText("cancel.name"))}var v="user",p=a.contextPath(),m=function(){return c("#rte-button-restrictions").parent().is(":visible")},e=null,g=null,d=null,h={addNames:function(a,
b){var e=this,d=a.replace(/\s*,\s*/g,",").split(","),h=c("#waitImage");h.show();var f={name:d,type:b||"",pageId:k.get("parent-page-id"),spaceKey:k.get("space-key")};c.getJSON(p+"/pages/getentities.action",f,function(b){h.hide();for(var a=0,i=b.length;a<i;a++){var f=b[a].entity;e.addEntity(b[a]);f=c.inArray(f.name,d);d.splice(f,1)}g.validator.handleNonExistentEntityNames(d)})},addEntity:function(a){if(a){var b=a.entity,a=a.report,c=g.getPermissionType();if(g.validator.isDuplicateEntityForType(b,c))d.highlightEntityRow(b,
c);else{d.addRow({entity:b,view:true,edit:true,report:a},c);n.Binder.userHover();d.changedByUser();d.highlightEntityRow(b,c);g.nameField.removeFromNameInput(b.name)}}},makePermissionStrings:function(){var a=d.makePermissionMap(false);return{viewPermissionsUsers:a.user.view.join(","),editPermissionsUsers:a.user.edit.join(","),viewPermissionsGroups:a.group.view.join(","),editPermissionsGroups:a.group.edit.join(",")}}};c.extend(a.PagePermissions,{addUserPermissions:function(a){h.addNames(a,v)},addGroupPermissions:function(a){h.addNames(a,
"group")},makePermissionStrings:h.makePermissionStrings,updateRestrictionsDialog:function(){e&&u(t,m())}});a.bind("deferred.page.permissions",function(){var f=m();if(!e){e=a.ConfluenceDialog({width:840,height:530,id:"update-page-restrictions-dialog",onCancel:s});k.get("content-type")=="blogpost"?e.addHeader(a.I18n.getText("page.perms.dialog.heading.blog")):e.addHeader(a.I18n.getText("page.perms.dialog.heading"));e.addPanel("Page Permissions Editor",n.Templates.PagePermissions.dialogPanel({currentUser:a.params.remoteUser,
currentUserAvatar:a.params.currentUserAvatarUrl}));e.addButton(a.I18n.getText("update.name"),y,"permissions-update-button");e.addCancel(a.I18n.getText("close.name"),s);e.popup.element.find(".dialog-title").prepend(n.Templates.PagePermissions.helpLink());e.popup.element.find(".dialog-button-panel").prepend("<div class='button-spinner'>&nbsp;</div>");e.popup.element.find("#userpicker-popup-link").click(function(){window.open(a.contextPath()+"/spaces/openuserpicker.action?key="+a.params.spaceKey+"&startIndex=0&onPopupSubmit=AJS.PagePermissions.addUserPermissions",
"EntitiesPicker","status=yes,resizable=yes,top=100,left=200,width=700,height=680,scrollbars=yes").focus();return false});e.popup.element.find("#grouppicker-popup-link").click(function(){window.open(a.contextPath()+"/spaces/opengrouppicker.action?key="+a.params.spaceKey+"&startIndex=0&actionName=dosearchgroups.action&onPopupSubmit=AJS.PagePermissions.addGroupPermissions","EntitiesPicker","status=yes,resizable=yes,top=100,left=200,width=580,height=550,scrollbars=yes").focus();return false});g=a.PagePermissions.Controls(h);
var b=c("#page-permissions-table").bind("changed",A);d=a.PagePermissions.Table(b);h.table=d}u(t,f);return false})}});require("confluence/module-exporter").safeRequire("confluence/page-permissions-manager",function(a){require("ajs").toInit(a)});