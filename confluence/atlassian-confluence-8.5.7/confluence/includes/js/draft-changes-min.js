define("confluence/draft-changes","jquery ajs window confluence/legacy confluence/api/ajax confluence/api/event confluence/api/logger confluence/analytics-support confluence/dark-features confluence/meta confluence/aui-overrides wrm/context-path".split(" "),function(b,d,q,c,v,r,n,k,s,j,t,l){return{init:function(){var a,p=function(a){var c=d.I18n.getText("discard.draft.confirmation"),f=b("#draft-"+a),h;if(confirm(c)){c=l()+"/rest/api/content/"+a+"?status=draft";h=b.ajax;h({url:c,type:"DELETE",data:{draftId:a},
contentType:"application/json",dataType:"json",success:function(a){if(a&&a.actionErrors){for(var b=["<ul>"],a=a.actionErrors,c=0;c<a.length;c++){n.log("error: "+a[c]);b.push("<li>"+a[c]+"</li>")}b.push("</ul>");d.messages.error("#errors",{title:d.I18n.getText("discard.draft.error.title"),body:d.I18n.getText("draft.saving.error.could.not.delete")+" "+b.join("\n")})}else{b=f.closest("table");a=b.closest(".drafts-container");f.remove();b.find("tbody tr").length===0&&a.append('<span id="no-drafts-message">'+
d.I18n.getText("no.drafts.found")+"</span>")}},error:function(a){d.messages.error("#errors",{title:d.I18n.getText("draft.saving.error.could.not.delete"),body:a.errors||d.I18n.getText("discard.draft.unknown.error")})}});return true}return false};b("body").on("click",".view-diff-link",function(u){var o=this.id,f=b(this);if(!a){var h=o==="view-diff-link-notification";a=new d.Dialog(860,530,"view-diff-draft-dialog");var e=d.I18n.getText("draft.heading");a.addHeader(e.replace(/\{0\}/,""));e=b(c.Templates.DraftChanges.dialogContent());
a.addPanel("Diff",e);if(h){a.addButton(d.I18n.getText("edit.name"),function(){a.hide();c.Editor&&c.Editor.Drafts?c.Editor.Drafts.useDraft():q.location=b(this).attr("data-href")},"resume-diff-link");a.addButton(d.I18n.getText("discard.name"),function(){if(s.isEnabled("editor.ajax.save")&&j.get("remote-user")!==""){c.Editor.SafeSave.Draft.discardDraft(d.params.pageId,j.get("existing-draft-id")).done(c.Editor.SafeSave.Draft.onSuccessDiscardDraft).fail(c.Editor.SafeSave.Draft.onErrorDiscardDraft);a.hide()}else if(c.Editor&&
c.Editor.Drafts){a.hide();c.Editor.Drafts.discardDraft(j.get("existing-draft-id"));k.publish("rte.notification.draft.discard")}else{var g=b(this).data("draftid");p(g)&&a.hide()}},"discard-diff-link")}a.addCancel(d.I18n.getText("close.name"),function(){a.hide();return false});e.removeClass("hidden")}a.addHeader(d.I18n.getText("loading.name"));b("#diff-view").html("<tr><td id='draft-changes-waiting-icon'>Loading...</td></tr>");var m,e=f.attr("class"),i=/draftPageId:([^ ]*)/.exec(e),f=i?i[1]:j.get("page-id"),
h=(i=/username:([^ ]*)/.exec(e))?i[1]:j.get("remote-user");m=(i=/draftId:([^ ]*)/.exec(e))?i[1]:null;b.ajax({url:l()+"/draftchanges/viewdraftchanges.action",type:"GET",dataType:"json",data:{pageId:f,username:h},success:function(g){if(g.actionErrors){for(var e="",g=g.actionErrors,f=0;f<g.length;f++){n.log("error: "+g[f]);e=e+"<div>"+g[f]+"</div>"}b("#diff-view").html(e)}else{b("#diff-view").html(g.htmlDiff);e=d.I18n.getText("draft.heading",d.escapeHtml(g.title));a.addHeader(e);a.popup.element.find(".dialog-title").prepend(c.Templates.DraftChanges.helpLink());
b(".resume-diff-link").attr("data-href",l()+"/pages/resumedraft.action?draftId="+m);b(".discard-diff-link").data("draftid",m);t.setVisible("#merge-warning",g.isMergeRequired)}},error:function(a){a=a.errors||"An unknown error has occurred. Please check your logs";b("#diff-view").html(a)}});a.show();r.trigger("analytics",{name:"confluence.editor.view-diff-dialog.open",data:{elementTriggerId:o}});u.stopPropagation();return false});b(".drafts-by-space li.draft-actions-list-item").on("click",".discard-draft-link",
function(a){a.preventDefault();k.publish("confluence.draft-list.discard");a=b(this).data("draftid");p(a)}).on("click",".resume-draft-link",function(){k.publish("confluence.drafts.referrer",{referrerPage:"drafts",lozengeType:"Draft"})})}}});require("confluence/module-exporter").safeRequire("confluence/draft-changes",function(b){require("ajs").toInit(b.init)});