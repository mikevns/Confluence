define("confluence/page-permissions-table",["jquery","confluence/meta","ajs","confluence/templates","confluence/aui-overrides"],function(b,n,i,m,k){return function(e){var j=this,l=!1;this.refresh=function(){b("#page-permissions-table-div").show();b("#page-inherited-permissions-table-div").show();var c=e.find(".view-permission-row"),g=0<e.find(".edit-permission-row").length;k.setVisible("#page-permissions-no-views",!(0<c.length));k.setVisible("#page-permissions-no-edits",!g);e.each(function(){b(".view-permission-row .page-permissions-marker-cell span",
this).removeClass("first-of-type").filter(":first").addClass("first-of-type");b(".edit-permission-row .page-permissions-marker-cell span",this).removeClass("first-of-type").filter(":first").addClass("first-of-type")});j.clearHighlight()};this.saveBackup=function(){this.copy=e.children().clone(!0)};this.restoreBackup=function(){e.children().remove();e.append(this.copy)};this.addCount=0;this.makePermissionMap=function(c){var g={user:{view:[],edit:[]},group:{view:[],edit:[]}};e.find("tr.view-permission-row, tr.edit-permission-row").each(function(){var a=
b(this),f=a.is(".user-permission")?"user":"group",d=a.is(".view-permission-row")?"view":"edit",a="user"===f?c?a.find(".permission-entity-display-name").text():a.attr("data-userkey"):a.find(".permission-entity-name").text();g[f][d].push(a)});return g};this.makePermissionMapForCheckboxes=function(c){var g={user:{view:[],edit:[]},group:{view:[],edit:[]}};e.find("tr.view-permission-row").each(function(){var a=b(this),f=a.find(".view-permission-cell input").prop("checked"),d=a.find(".edit-permission-cell input").prop("checked");
if(f||d){var e=a.hasClass("user-permission")?"user":"group",h=a.find(".permission-entity-"+(c&&"user"===e?"display-name":"name")).text();f&&(c||!a.hasClass("readonly-permission"))&&g[e].view.push(h);d&&g[e].edit.push(h)}});return g};this.addRow=function(c,g){var a=c.entity,f=b(m.PagePermissions.permissionRow());f.addClass(a.type+"-permission");f.addClass(g+"-permission-row");"edit"==g&&f.find(".page-permissions-marker-cell span").text(i.I18n.getText("page.perms.editing.restricted.to"));var d=f.find("td.permission-entity");
d.find(".permission-entity-name").text(a.name);d.find(".permission-entity-display-name").text(a.fullName||a.name);"group"===a.type&&(d.find("img").attr("src",i.contextPath()+"/images/icons/avatar_group_32.png"),d.find(".permission-entity-name-wrap").hide());"user"===a.type&&(d.find("img").attr("src",a.avatarUrl),d.find("span.entity-container").addClass("content-hover user-hover-trigger").attr("data-username",a.name),f.attr("data-userkey",a.userKey));(a=!l||c.inherited||c.readOnly)&&f.addClass("readonly-permission");
d=f.find(".remove-permission-link");a||!l?d.remove():(d.attr("id","remove-permission-"+this.addCount++),d.click(function(a){b(this).closest("tr").remove();j.changedByUser();a.stopPropagation();return false}));if(c.inherited){a=b(".page-permissions-table[owningTitle='"+i.escape(c.owningTitle)+"']");if(!a.length){d=b(m.PagePermissions.inheritedPermissionsTable());a=d.find("table");a.attr("owningTitle",i.escape(c.owningTitle));var k=d.find(".page-inherited-permissions-table-desc"),h=k.find("a"),o=i.contextPath()+
"/pages/viewpage.action?pageId="+c.owningId;h.attr("href",o).attr("target","_blank").text(c.owningTitle).addClass("page-perms-owningTitle");h=b("#content-title");h=h.length?h.val():n.get("page-title");k.find("span").addClass(".page-perms-inherited-this-page").text(h);b("#page-inherited-permissions-tables").append(d)}a.append(f);b("#page-inherited-permissions-table-desc").show();b("#page-inherited-permissions-table-div").removeClass("hidden")}else"view"==g?b("#page-permissions-no-edits").before(f):
e.append(f)};this.changedByUser=function(){e.trigger("changed");j.clearHighlight();j.refresh()};this.resetDirect=function(){e.find("tr:not(.marker-row)").remove();j.addCount=0};this.resetInherited=function(){b("#page-inherited-permissions-table-desc").hide();b("#page-inherited-permissions-tables div").remove()};e.click(function(){j.clearHighlight()});b("#page-inherited-permissions-table-desc").click(function(){b(".page-inheritance-togglable").toggleClass("hidden");b(".icon",this).toggleClass("twisty-open").toggleClass("twisty-closed")});
this.highlightEntityRow=function(c,g){var a=e.find("."+g+"-permission-row").filter(function(){return b(".permission-entity-name",this).text()===c.name});b("#page-permissions-tables").simpleScrollTo(a);a.addClass("highlighted-permission")};this.clearHighlight=function(){b("tr.highlighted-permission").removeClass("highlighted-permission")};this.allowEditing=function(b){l=b};this.showErrorMessage=function(c){b("#page-permissions-table-div").hide();b("#page-inherited-permissions-table-div").hide();b("#page-permissions-tables-error").remove();
i.messages.warning("#page-permissions-tables",{title:c,id:"page-permissions-tables-error",insert:"prepend"})};return this}});require("confluence/module-exporter").exportModuleAsGlobal("confluence/page-permissions-table","AJS.PagePermissions.Table");